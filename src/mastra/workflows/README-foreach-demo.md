# .foreach() ç‰¹æ€§æ¼”ç¤º - æ‰¹é‡æ–‡æ¡£å¤„ç†å™¨

è¿™ä¸ªæ¼”ç¤ºå±•ç¤ºäº† Mastra å·¥ä½œæµä¸­ `.foreach()` ç‰¹æ€§çš„ä½¿ç”¨æ–¹æ³•ï¼Œé€šè¿‡ä¸€ä¸ªå®ç”¨çš„æ‰¹é‡æ–‡æ¡£å¤„ç†å™¨æ¥è¯´æ˜å¦‚ä½•å¯¹é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŒçš„å¤„ç†æ­¥éª¤ï¼Œå¹¶æ”¯æŒå¹¶å‘æ§åˆ¶ã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

- `batch-document-processor-workflow.ts` - ä¸»è¦çš„å·¥ä½œæµå®šä¹‰
- `batch-document-processor-example.ts` - ä½¿ç”¨ç¤ºä¾‹å’Œè¯¦ç»†è¯´æ˜
- `README-foreach-demo.md` - æœ¬æ–‡æ¡£

## ğŸ“š å·¥ä½œæµç¨‹

1. **åˆå§‹åŒ–æ­¥éª¤** (`initBatchStep`)
   - æ¥æ”¶æ–‡æ¡£é›†åˆ
   - è®°å½•æ‰¹é‡å¤„ç†å¼€å§‹æ—¶é—´
   - æ˜¾ç¤ºå¾…å¤„ç†æ–‡æ¡£åˆ—è¡¨

2. **æ–‡æ¡£å¤„ç†æ­¥éª¤** (`processDocumentStep`) - **å…³é”®çš„å¾ªç¯æ­¥éª¤**
   - å¯¹æ¯ä¸ªæ–‡æ¡£æ‰§è¡Œç›¸åŒçš„å¤„ç†é€»è¾‘
   - å†…å®¹åˆ†å—ã€è¯æ±‡åˆ†æã€å…³é”®è¯æå–
   - ç”Ÿæˆæ‘˜è¦å’Œç»Ÿè®¡ä¿¡æ¯

3. **æ±‡æ€»æ­¥éª¤** (`summarizeBatchStep`)
   - æ”¶é›†æ‰€æœ‰å¤„ç†ç»“æœ
   - ç”Ÿæˆæ‰¹é‡å¤„ç†ç»Ÿè®¡æŠ¥å‘Š
   - åˆ†ææ•´ä½“è¶‹åŠ¿å’Œæ¨¡å¼

## ğŸ”„ .foreach() ç‰¹æ€§è¯¦è§£

### è¯­æ³•ç»“æ„

æ ¹æ® [Mastra å®˜æ–¹æ–‡æ¡£](https://mastra.ai/reference/workflows/workflow-methods/foreach)ï¼š

```typescript
workflow.foreach(step, { concurrency: 2 });
```

### åœ¨æœ¬æ¼”ç¤ºä¸­çš„ä½¿ç”¨

```typescript
// 1. å‰ä¸€æ­¥è¿”å›æ–‡æ¡£æ•°ç»„
.map(async ({ inputData }) => {
  return documents.map(doc => ({
    ...doc,
    processingStartTime: Date.now(),
  }));
})

// 2. .foreach() å¯¹æ¯ä¸ªå…ƒç´ æ‰§è¡Œç›¸åŒçš„æ­¥éª¤
.foreach(processDocumentStep, { concurrency: 2 })

// 3. æ”¶é›†å¤„ç†ç»“æœ
.map(async ({ inputData }) => {
  return { processedDocuments: inputData };
})
```

### æ‰§è¡Œé€»è¾‘

1. **å‰ç½®æ¡ä»¶**: å‰ä¸€ä¸ªæ­¥éª¤å¿…é¡»è¿”å›æ•°ç»„ç±»å‹
2. **å¾ªç¯æ‰§è¡Œ**: å¯¹æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ æ‰§è¡ŒæŒ‡å®šçš„æ­¥éª¤
3. **å¹¶å‘æ§åˆ¶**: æ ¹æ® `concurrency` å‚æ•°æ§åˆ¶å¹¶å‘æ•°é‡
4. **ç»“æœæ”¶é›†**: è‡ªåŠ¨æ”¶é›†æ‰€æœ‰å¤„ç†ç»“æœåˆ°æ•°ç»„ä¸­

### å…³é”®ç‰¹ç‚¹

- **æ•°ç»„å¤„ç†**: ä¸“é—¨ç”¨äºå¤„ç†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ 
- **å¹¶å‘æ”¯æŒ**: æ”¯æŒå¹¶å‘æ‰§è¡Œï¼Œæé«˜å¤„ç†æ•ˆç‡
- **ç‹¬ç«‹å¤„ç†**: æ¯ä¸ªå…ƒç´ çš„å¤„ç†æ˜¯ç‹¬ç«‹çš„
- **ç»“æœæ”¶é›†**: è‡ªåŠ¨æ”¶é›†æ‰€æœ‰å¤„ç†ç»“æœ
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹æ”¯æŒ
- **æ€§èƒ½ä¼˜åŒ–**: é€šè¿‡å¹¶å‘æ§åˆ¶ä¼˜åŒ–èµ„æºä½¿ç”¨

## ğŸš€ è¿è¡Œç¤ºä¾‹

### æ–¹æ³•1: ç›´æ¥è¿è¡Œç¤ºä¾‹æ–‡ä»¶

```bash
npx ts-node src/mastra/workflows/batch-document-processor-example.ts
```

### æ–¹æ³•2: åœ¨ä»£ç ä¸­ä½¿ç”¨

```typescript
import { mastra } from '../index';

// å‡†å¤‡æ–‡æ¡£æ•°æ®
const documents = [
  {
    id: 'doc-1',
    title: 'æŠ€æœ¯æŠ¥å‘Š',
    content: 'è¿™æ˜¯ä¸€ä»½å…³äºäººå·¥æ™ºèƒ½çš„æŠ€æœ¯æŠ¥å‘Š...',
    category: 'æŠ€æœ¯',
  },
  // ... æ›´å¤šæ–‡æ¡£
];

// é€šè¿‡ mastra å®ä¾‹è·å–å·¥ä½œæµ
const workflow = mastra.getWorkflow('batchDocumentProcessorWorkflow');

// å¯åŠ¨æ‰¹é‡å¤„ç†
const result = await workflow.execute({ documents });

// è·å–å¤„ç†ç»“æœ
console.log('æ‰¹é‡å¤„ç†ç»“æœ:', result);
```

**æ³¨æ„**: å½“å‰çš„ç¤ºä¾‹æ–‡ä»¶ä½¿ç”¨æ¨¡æ‹Ÿæ‰§è¡Œæ¥æ¼”ç¤ºå·¥ä½œæµé€»è¾‘ï¼Œå› ä¸ºå®Œæ•´çš„ Mastra è¿è¡Œæ—¶ç¯å¢ƒè®¾ç½®è¾ƒä¸ºå¤æ‚ã€‚å®é™…ä½¿ç”¨æ—¶éœ€è¦æŒ‰ç…§ä¸Šè¿°æ–¹å¼é€šè¿‡ `mastra` å®ä¾‹æ¥æ‰§è¡Œå·¥ä½œæµã€‚

## ğŸ“Š ç¤ºä¾‹è¾“å‡º

```
ğŸ“š å¼€å§‹æ‰¹é‡æ–‡æ¡£å¤„ç†å™¨æ¼”ç¤º...

âš ï¸  æ³¨æ„ï¼šè¿™æ˜¯æ¼”ç¤ºä»£ç ï¼Œå®é™…æ‰§è¡Œéœ€è¦å®Œæ•´çš„ Mastra è¿è¡Œæ—¶ç¯å¢ƒ

ğŸ“„ å‡†å¤‡å¤„ç† 5 ä¸ªæ–‡æ¡£:
  1. "äººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•æŠ¥å‘Š" (456 å­—ç¬¦, åˆ†ç±»: æŠ€æœ¯æŠ¥å‘Š)
  2. "åŒºå—é“¾åº”ç”¨æ¡ˆä¾‹åˆ†æ" (378 å­—ç¬¦, åˆ†ç±»: æŠ€æœ¯åˆ†æ)
  3. "äº‘è®¡ç®—æœåŠ¡å‘å±•è¶‹åŠ¿" (342 å­—ç¬¦, åˆ†ç±»: è¡Œä¸šè¶‹åŠ¿)
  4. "æ•°æ®ç§‘å­¦å®è·µæŒ‡å—" (298 å­—ç¬¦, åˆ†ç±»: å®è·µæŒ‡å—)
  5. "ç½‘ç»œå®‰å…¨é˜²æŠ¤ç­–ç•¥" (334 å­—ç¬¦, åˆ†ç±»: å®‰å…¨ç­–ç•¥)

============================================================
ğŸ“š æ‰¹é‡æ–‡æ¡£å¤„ç†å™¨å¯åŠ¨ï¼
ğŸ“„ å¾…å¤„ç†æ–‡æ¡£æ•°é‡: 5
ğŸ• å¼€å§‹æ—¶é—´: 2024/11/10 ä¸‹åˆ2:30:15
============================================================

ğŸ”„ å¼€å§‹ .forEach() å¤„ç†æ¯ä¸ªæ–‡æ¡£...

ğŸ“„ [1/5] å¤„ç†æ–‡æ¡£: "äººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•æŠ¥å‘Š"
ğŸ“ å†…å®¹é•¿åº¦: 456 å­—ç¬¦
ğŸ·ï¸ åˆ†ç±»: æŠ€æœ¯æŠ¥å‘Š
ğŸ“¦ åˆ†å—æ•°é‡: 3
ğŸ”¤ è¯æ±‡æ•°é‡: 89
ğŸ·ï¸ å…³é”®è¯: äººå·¥æ™ºèƒ½, æŠ€æœ¯, å­¦ä¹ , åº”ç”¨, å‘å±•
ğŸ“‹ æ‘˜è¦: äººå·¥æ™ºèƒ½æŠ€æœ¯åœ¨è¿‘å¹´æ¥å–å¾—äº†çªç ´æ€§è¿›å±•ã€‚æœºå™¨å­¦ä¹ ç®—æ³•ä¸æ–­ä¼˜åŒ–ï¼Œæ·±åº¦å­¦ä¹ æ¨¡å‹åœ¨å›¾åƒè¯†åˆ«ã€è‡ªç„¶è¯­è¨€å¤„ç†ç­‰é¢†åŸŸè¡¨ç°å‡ºè‰²...
â±ï¸ å¤„ç†è€—æ—¶: 45ms
âœ… æ–‡æ¡£å¤„ç†å®Œæˆ

ğŸ“„ [2/5] å¤„ç†æ–‡æ¡£: "åŒºå—é“¾åº”ç”¨æ¡ˆä¾‹åˆ†æ"
ğŸ“ å†…å®¹é•¿åº¦: 378 å­—ç¬¦
ğŸ·ï¸ åˆ†ç±»: æŠ€æœ¯åˆ†æ
ğŸ“¦ åˆ†å—æ•°é‡: 2
ğŸ”¤ è¯æ±‡æ•°é‡: 72
ğŸ·ï¸ å…³é”®è¯: åŒºå—é“¾, æŠ€æœ¯, åº”ç”¨, æ™ºèƒ½, åˆçº¦
ğŸ“‹ æ‘˜è¦: åŒºå—é“¾æŠ€æœ¯ä½œä¸ºåˆ†å¸ƒå¼è´¦æœ¬æŠ€æœ¯ï¼Œåœ¨é‡‘èã€ä¾›åº”é“¾ã€æ•°å­—èº«ä»½ç­‰é¢†åŸŸå±•ç°å‡ºå·¨å¤§æ½œåŠ›ã€‚æ¯”ç‰¹å¸å’Œä»¥å¤ªåŠç­‰åŠ å¯†è´§å¸çš„æˆåŠŸ...
â±ï¸ å¤„ç†è€—æ—¶: 38ms
âœ… æ–‡æ¡£å¤„ç†å®Œæˆ

[... å…¶ä»–æ–‡æ¡£å¤„ç†è¿‡ç¨‹ ...]

============================================================
ğŸ“Š æ‰¹é‡å¤„ç†å®Œæˆï¼ç”Ÿæˆç»Ÿè®¡æŠ¥å‘Š...
============================================================

æ‰¹é‡æ–‡æ¡£å¤„ç†æŠ¥å‘Š
==================
ğŸ“„ å¤„ç†æ–‡æ¡£æ•°é‡: 5
â±ï¸ æ€»å¤„ç†æ—¶é—´: 1247ms
ğŸ“ˆ å¹³å‡å¤„ç†æ—¶é—´: 249ms/æ–‡æ¡£
ğŸ”¤ æ€»è¯æ±‡æ•°é‡: 387
ğŸ“¦ æ€»åˆ†å—æ•°é‡: 12
ğŸ·ï¸ åˆ†ç±»æ•°é‡: 5
ğŸ“‚ åˆ†ç±»åˆ—è¡¨: æŠ€æœ¯æŠ¥å‘Š, æŠ€æœ¯åˆ†æ, è¡Œä¸šè¶‹åŠ¿, å®è·µæŒ‡å—, å®‰å…¨ç­–ç•¥
ğŸ”¥ çƒ­é—¨å…³é”®è¯: æŠ€æœ¯, åº”ç”¨, æ•°æ®, æœåŠ¡, ç³»ç»Ÿ, å®‰å…¨, å­¦ä¹ , è®¡ç®—

è¯¦ç»†å¤„ç†ç»“æœ:
1. "äººå·¥æ™ºèƒ½æŠ€æœ¯å‘å±•æŠ¥å‘Š" - 89è¯, 3å—, 45ms
2. "åŒºå—é“¾åº”ç”¨æ¡ˆä¾‹åˆ†æ" - 72è¯, 2å—, 38ms
3. "äº‘è®¡ç®—æœåŠ¡å‘å±•è¶‹åŠ¿" - 68è¯, 2å—, 42ms
4. "æ•°æ®ç§‘å­¦å®è·µæŒ‡å—" - 61è¯, 2å—, 35ms
5. "ç½‘ç»œå®‰å…¨é˜²æŠ¤ç­–ç•¥" - 67è¯, 2å—, 40ms

ğŸ‰ æ‰¹é‡æ–‡æ¡£å¤„ç†æ¼”ç¤ºå®Œæˆï¼
```

## ğŸ’¡ é€‚ç”¨åœºæ™¯

`.forEach()` ç‰¹æ€§ç‰¹åˆ«é€‚åˆä»¥ä¸‹åœºæ™¯ï¼š

### ğŸ“„ æ–‡æ¡£å¤„ç†
- æ‰¹é‡æ–‡æ¡£åˆ†æå’Œæ‘˜è¦
- æ‰¹é‡æ ¼å¼è½¬æ¢
- æ‰¹é‡å†…å®¹æå–

### ğŸ–¼ï¸ åª’ä½“å¤„ç†
- æ‰¹é‡å›¾ç‰‡å¤„ç†å’Œå‹ç¼©
- æ‰¹é‡éŸ³é¢‘è½¬ç 
- æ‰¹é‡è§†é¢‘åˆ†æ

### ğŸŒ API æ“ä½œ
- æ‰¹é‡APIè°ƒç”¨
- æ‰¹é‡æ•°æ®åŒæ­¥
- æ‰¹é‡çŠ¶æ€æ›´æ–°

### ğŸ“§ é€šä¿¡å¤„ç†
- æ‰¹é‡é‚®ä»¶å‘é€
- æ‰¹é‡é€šçŸ¥æ¨é€
- æ‰¹é‡æ¶ˆæ¯å¤„ç†

### ğŸ—„ï¸ æ•°æ®æ“ä½œ
- æ‰¹é‡æ•°æ®éªŒè¯
- æ‰¹é‡æ•°æ®è½¬æ¢
- æ‰¹é‡æ•°æ®åº“æ“ä½œ

## ğŸ†š ä¸å…¶ä»–å¾ªç¯æ–¹æ³•çš„å¯¹æ¯”

| ç‰¹æ€§ | .foreach() | .dowhile() | .dountil() | .map() |
|------|------------|------------|------------|--------|
| **å¤„ç†å¯¹è±¡** | æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´  | é‡å¤æ‰§è¡Œå•ä¸ªæ­¥éª¤ | é‡å¤æ‰§è¡Œå•ä¸ªæ­¥éª¤ | æ•°æ®è½¬æ¢ |
| **æ‰§è¡Œæ¬¡æ•°** | ç­‰äºæ•°ç»„å…ƒç´ æ•°é‡ | æ ¹æ®æ¡ä»¶å†³å®š | æ ¹æ®æ¡ä»¶å†³å®š | ä¸€æ¬¡ |
| **å¹¶å‘æ”¯æŒ** | âœ… æ”¯æŒå¹¶å‘æ§åˆ¶ | âŒ ä¸²è¡Œæ‰§è¡Œ | âŒ ä¸²è¡Œæ‰§è¡Œ | âŒ ä¸€æ¬¡æ€§å¤„ç† |
| **å‰ç½®æ¡ä»¶** | å‰ä¸€æ­¥è¿”å›æ•°ç»„ | æ— ç‰¹æ®Šè¦æ±‚ | æ— ç‰¹æ®Šè¦æ±‚ | æ— ç‰¹æ®Šè¦æ±‚ |
| **ç»“æœæ”¶é›†** | è‡ªåŠ¨æ”¶é›†åˆ°æ•°ç»„ | è¿”å›æœ€åä¸€æ¬¡ç»“æœ | è¿”å›æœ€åä¸€æ¬¡ç»“æœ | è½¬æ¢åçš„æ•°æ® |
| **é€‚ç”¨åœºæ™¯** | æ‰¹é‡å¹¶å‘å¤„ç† | æ¡ä»¶å¾ªç¯ | ç›®æ ‡è¾¾æˆå¾ªç¯ | æ•°æ®è½¬æ¢ |

## ğŸ¯ æœ€ä½³å®è·µ

### 1. åˆç†æ§åˆ¶æ‰¹é‡å¤§å°
```typescript
// å¯¹äºå¤§é‡æ•°æ®ï¼Œè€ƒè™‘åˆ†æ‰¹å¤„ç†
const batchSize = 100;
const batches = chunkArray(largeDataset, batchSize);

for (const batch of batches) {
  await workflow.execute({ documents: batch });
}
```

### 2. é”™è¯¯å¤„ç†å’Œé‡è¯•
```typescript
const processDocumentStep = createStep({
  // ... å…¶ä»–é…ç½®
  execute: async ({ inputData }) => {
    try {
      return await processDocument(inputData);
    } catch (error) {
      console.error(`å¤„ç†æ–‡æ¡£å¤±è´¥: ${inputData.title}`, error);
      // è¿”å›é”™è¯¯çŠ¶æ€è€Œä¸æ˜¯æŠ›å‡ºå¼‚å¸¸
      return { ...inputData, error: error.message, processed: false };
    }
  },
});
```

### 3. è¿›åº¦è¿½è¸ª
```typescript
.forEach(
  async ({ inputData: { documents } }) => {
    return documents.map((doc, index) => ({
      ...doc,
      batchIndex: index + 1,
      totalCount: documents.length,
    }));
  },
  createStep({
    // ... å…¶ä»–é…ç½®
    execute: async ({ inputData }) => {
      console.log(`å¤„ç†è¿›åº¦: ${inputData.batchIndex}/${inputData.totalCount}`);
      // ... å¤„ç†é€»è¾‘
    },
  })
)
```

### 4. èµ„æºç®¡ç†
```typescript
// å¯¹äºèµ„æºå¯†é›†å‹æ“ä½œï¼Œæ·»åŠ å»¶è¿Ÿ
const processDocumentStep = createStep({
  // ... å…¶ä»–é…ç½®
  execute: async ({ inputData }) => {
    const result = await heavyProcessing(inputData);
    
    // æ·»åŠ å°å»¶è¿Ÿé¿å…èµ„æºè¿‡è½½
    await new Promise(resolve => setTimeout(resolve, 100));
    
    return result;
  },
});
```

## ğŸ”— ç›¸å…³èµ„æº

- [Mastra å·¥ä½œæµå®˜æ–¹æ–‡æ¡£](https://mastra.ai/reference/workflows)
- [.dowhile() ç‰¹æ€§æ¼”ç¤º](./README-dowhile-demo.md)
- [.dountil() ç‰¹æ€§æ¼”ç¤º](./README-dountil-demo.md)
- [å¹¶è¡Œå¤„ç†æ¼”ç¤º](./README-parallel-demo.md)
