# 管理员API文档

## 概述
管理员API提供系统管理功能，包括用户管理、角色分配和权限控制。只有具备管理员权限的用户才能访问这些接口。

## 基础路径
```
/api
```

## 认证方式
- 需要用户登录会话（express-session）
- 需要管理员权限（is_admin = true）
- 特殊说明：当系统中没有角色记录时，允许任何已认证用户执行管理员操作（用于初始设置）

## 接口列表

### 1. 设置用户管理员角色

#### 请求
```http
POST /api/admin/set-admin-role
```

#### 请求体
```json
{
  "user_id": 123,
  "is_admin": true
}
```

#### 参数说明
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| user_id | number | 是 | 用户ID |
| is_admin | boolean | 是 | 是否设置为管理员 |

#### 响应
**成功 (200)**
```json
{
  "user_id": 123,
  "is_admin": true
}
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 400 | 参数错误（缺少user_id或is_admin，或无效的user_id） |
| 401 | 未认证或用户不存在 |
| 403 | 无权限（非管理员且系统中已有角色记录） |
| 500 | 服务器内部错误 |

---

### 2. 获取用户列表

#### 请求
```http
GET /api/admin/users
```

#### 响应
**成功 (200)**
```json
[
  {
    "id": 123,
    "email": "user@example.com",
    "name": "张三",
    "surname": "李四",
    "created_at": "2024-01-01T00:00:00.000Z",
    "role": "admin"
  },
  {
    "id": 124,
    "email": "user2@example.com",
    "name": "王五",
    "surname": null,
    "created_at": "2024-01-02T00:00:00.000Z",
    "role": "user"
  }
]
```

#### 响应字段说明
| 字段 | 类型 | 说明 |
|------|------|------|
| id | number | 用户ID |
| email | string | 邮箱地址 |
| name | string | 名字 |
| surname | string | 姓氏 |
| created_at | string | 创建时间（ISO 8601格式） |
| role | string | 角色：admin 或 user |

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 401 | 未认证 |
| 403 | 无权限（不是管理员） |
| 500 | 服务器内部错误 |

---

### 3. 创建用户

#### 请求
```http
POST /api/admin/users
```

#### 请求体
```json
{
  "email": "newuser@example.com",
  "password": "password123",
  "name": "新用户",
  "surname": "测试",
  "role": "user"
}
```

#### 参数说明
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 是 | 邮箱地址（必须包含@） |
| password | string | 是 | 密码（至少6个字符） |
| name | string | 否 | 名字 |
| surname | string | 否 | 姓氏 |
| role | string | 否 | 角色：admin 或 user（默认为user） |

#### 响应
**成功 (201)**
```json
{
  "id": 125,
  "email": "newuser@example.com",
  "name": "新用户",
  "surname": "测试",
  "created_at": "2024-01-03T00:00:00.000Z",
  "role": "user"
}
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 400 | 参数错误（邮箱格式不正确、密码长度不足、缺少必填参数） |
| 401 | 未认证 |
| 403 | 无权限（不是管理员） |
| 409 | 邮箱已存在 |
| 500 | 服务器内部错误 |

---

### 4. 更新用户

#### 请求
```http
PUT /api/admin/users/:id
```

#### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | number | 是 | 用户ID |

#### 请求体
```json
{
  "email": "updated@example.com",
  "password": "newpassword123",
  "name": "更新后的名字",
  "surname": "更新后的姓氏",
  "role": "admin"
}
```

#### 参数说明
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | string | 否 | 邮箱地址（必须包含@） |
| password | string | 否 | 新密码（至少6个字符，空字符串将忽略） |
| name | string | 否 | 名字（设置为null或空字符串可清除） |
| surname | string | 否 | 姓氏（设置为null或空字符串可清除） |
| role | string | 否 | 角色：admin 或 user |

#### 响应
**成功 (200)**
```json
{
  "id": 125,
  "email": "updated@example.com",
  "name": "更新后的名字",
  "surname": "更新后的姓氏",
  "created_at": "2024-01-03T00:00:00.000Z",
  "role": "admin"
}
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 400 | 参数错误（无效的用户ID、邮箱格式不正确、密码长度不足） |
| 401 | 未认证 |
| 403 | 无权限（不是管理员） |
| 404 | 用户不存在 |
| 409 | 邮箱已存在 |
| 500 | 服务器内部错误 |

---

### 5. 删除用户

#### 请求
```http
DELETE /api/admin/users/:id
```

#### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| id | number | 是 | 用户ID |

#### 响应
**成功 (204)**
```
No Content
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 400 | 参数错误（无效的用户ID、尝试删除自己的账户） |
| 401 | 未认证 |
| 403 | 无权限（不是管理员） |
| 404 | 用户不存在 |
| 400 | 不能删除最后一个管理员 |

## 注意事项
1. **权限控制**：除设置管理员角色外的所有接口都需要当前用户是管理员
2. **引导模式**：当系统中没有任何角色记录时，允许任何已认证用户执行管理员操作（用于首次设置管理员）
3. **自我保护**：用户不能删除自己的账户
4. **管理员保护**：不能删除最后一个管理员账户
5. **密码处理**：密码在User模型中会自动进行哈希处理
6. **唯一性**：邮箱地址必须唯一
