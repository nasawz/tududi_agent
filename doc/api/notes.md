# 笔记管理API文档

## 概述
笔记管理API提供笔记的完整CRUD操作，支持Markdown格式、标签管理和项目关联。

## 基础路径
```
/api/notes
```

## 认证方式
- 需要有效的登录会话
- 需要笔记访问权限（通过hasAccess中间件）
- 权限包括：ro（只读）和rw（读写）

## 数据模型

### Note（笔记）
| 字段 | 类型 | 说明 |
|------|------|------|
| uid | string | 笔记唯一标识符 |
| title | string | 笔记标题 |
| content | string | 笔记内容（支持Markdown） |
| project_id | number | 所属项目ID |
| user_id | number | 创建者ID |

## 接口列表

### 1. 获取笔记列表

#### 请求
```http
GET /api/notes
```

#### 查询参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| order_by | string | 否 | 排序方式（默认title:asc） |
| tag | string | 否 | 按标签筛选 |

#### 响应
**成功 (200)**
```json
[
  {
    "uid": "note_abc123",
    "title": "项目需求文档",
    "content": "# 项目需求\n\n详细需求内容...",
    "project_id": 5,
    "user_id": 1,
    "created_at": "2024-01-01T00:00:00.000Z",
    "updated_at": "2024-01-15T00:00:00.000Z",
    "tags": [
      {
        "name": "重要",
        "uid": "tag_important123"
      }
    ],
    "Project": {
      "name": "项目A",
      "uid": "proj_abc123"
    }
  }
]
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 500 | 服务器内部错误 |

---

### 2. 获取笔记详情

#### 请求
```http
GET /api/note/note_abc123-my-note-title
```

#### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| uidSlug | string | 是 | 笔记UID或UID-标题格式的slug |

#### 响应
**成功 (200)**
```json
{
  "uid": "note_abc123",
  "title": "项目需求文档",
  "content": "# 项目需求\n\n详细需求内容...\n\n## 功能需求\n1. 用户管理\n2. 权限控制",
  "project_id": 5,
  "user_id": 1,
  "created_at": "2024-01-01T00:00:00.000Z",
  "updated_at": "2024-01-15T00:00:00.000Z",
  "tags": [
    {
      "name": "重要",
      "uid": "tag_important123"
    },
    {
      "name": "文档",
      "uid": "tag_doc456"
    }
  ],
  "Project": {
    "name": "项目A",
    "uid": "proj_abc123"
  }
}
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 404 | 笔记不存在或无访问权限 |
| 500 | 服务器内部错误 |

---

### 3. 创建笔记

#### 请求
```http
POST /api/note
```

#### 请求体
```json
{
  "title": "新笔记标题",
  "content": "# 笔记内容\n\n这里是Markdown格式的内容",
  "project_uid": "proj_abc123",
  "project_id": 5,
  "tags": ["重要", "文档"]
}
```

#### 参数说明
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| title | string | 是 | 笔记标题 |
| content | string | 是 | 笔记内容（支持Markdown） |
| project_uid | string | 否 | 项目UID |
| project_id | number | 否 | 项目ID（与project_uid二选一） |
| tags | array | 否 | 标签数组 |

#### 响应
**成功 (201)**
```json
{
  "uid": "note_new123",
  "title": "新笔记标题",
  "content": "# 笔记内容\n\n这里是Markdown格式的内容",
  "project_id": 5,
  "user_id": 1,
  "created_at": "2024-01-15T10:00:00.000Z",
  "updated_at": "2024-01-15T10:00:00.000Z",
  "tags": [
    {
      "name": "重要",
      "uid": "tag_important123"
    },
    {
      "name": "文档",
      "uid": "tag_doc456"
    }
  ]
}
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 400 | 参数错误或验证失败 |
| 500 | 服务器内部错误 |

---

### 4. 更新笔记

#### 请求
```http
PATCH /api/note/note_abc123
```

#### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| uid | string | 是 | 笔记UID |

#### 请求体
```json
{
  "title": "更新后的标题",
  "content": "# 更新后的内容",
  "tags": ["重要", "更新"]
}
```

#### 参数说明
所有参数均为可选，只更新提供的字段。

#### 响应
**成功 (200)**
```json
{
  "uid": "note_abc123",
  "title": "更新后的标题",
  "content": "# 更新后的内容",
  "project_id": 5,
  "updated_at": "2024-01-15T12:00:00.000Z",
  "tags": [
    {
      "name": "重要",
      "uid": "tag_important123"
    },
    {
      "name": "更新",
      "uid": "tag_update789"
    }
  ]
}
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 404 | 笔记不存在或无访问权限 |
| 400 | 参数错误 |
| 500 | 服务器内部错误 |

---

### 5. 删除笔记

#### 请求
```http
DELETE /api/note/note_abc123
```

#### 路径参数
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| uid | string | 是 | 笔记UID |

#### 响应
**成功 (204)**
```
No Content
```

#### 错误响应
| 状态码 | 说明 |
|--------|------|
| 404 | 笔记不存在或无访问权限 |
| 500 | 服务器内部错误 |

## 标签系统

### 标签管理
- 笔记可以关联多个标签
- 标签名称会自动验证
- 不存在的标签会自动创建
- 更新时提供新标签数组会完全替换现有标签

### 标签筛选
```http
GET /api/notes?tag=重要
```

## 项目关联

### 关联方式
- 通过 `project_uid` 关联（推荐）
- 通过 `project_id` 关联（传统方式）
- 可以不关联任何项目

### 关联查询
关联的项目信息会在响应中返回：
```json
{
  "Project": {
    "name": "项目名称",
    "uid": "项目UID"
  }
}
```

## Markdown支持

### 内容格式
笔记内容支持标准Markdown语法：
- 标题：`# ## ###`
- 列表：`- * 1.`
- 粗体：`**text**`
- 斜体：`*text*`
- 代码：```code```
- 链接：`[text](url)`

### 示例
```markdown
# 会议纪要

## 参会人员
- 张三
- 李四

## 决议事项
1. 确定项目时间线
2. 分配任务

## 下次会议
2024-01-20 14:00
```

## 权限系统

### 访问级别
- **ro（只读）**：可以查看笔记内容和标签
- **rw（读写）**：可以修改和删除笔记

### 权限检查
通过 `hasAccess` 中间件自动检查，基于：
- 笔记所有权
- 项目共享权限

## 使用场景

### 项目文档
- 项目需求文档
- 技术方案说明
- 会议纪要
- 用户手册

### 知识管理
- 学习笔记
- 经验总结
- 最佳实践
- 问题解决方案

### 协作
- 团队共享文档
- 跨项目知识库
- 文档版本管理

## 注意事项
1. **UID格式**：笔记UID以`note_`开头
2. **Slug支持**：可通过`uid`或`uid-title`格式访问
3. **标签验证**：无效标签名称会导致请求失败
4. **Markdown渲染**：前端需要支持Markdown渲染
5. **权限继承**：通过项目共享的权限会自动应用到笔记

## 相关端点
- **项目**：`/api/projects/*` - 项目管理
- **标签**：`/api/tags/*` - 标签管理
- **搜索**：`/api/search/*` - 搜索笔记
- **共享**：`/api/shares/*` - 共享笔记
